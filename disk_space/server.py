import aiohttp.web
import math
from time import time, asctime

# Just general functions

# 0 is green, 1 is red, 0.8 is yellow
def colour_gradient(percentage):
    if percentage <= 0.8:
        return (int((percentage/0.8)*255), 255, 0)
    else:
        return(255, int(((1-percentage)/0.2)*255), 0)

# I borrowed this off StackOverflow... Everything else in this file is mine though!
def convert_size(size_bytes):
   if size_bytes == 0:
       return "0B"
   size_name = ("B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB")
   i = int(math.floor(math.log(size_bytes, 1024)))
   p = math.pow(1024, i)
   s = round(size_bytes / p, 2)
   return "%s %s" % (s, size_name[i])

# Application specific stuff

BASE = '<!DOCTYPE html><html lang=en><meta charset=utf-8><script>function reloadPage () {location.reload();};setInterval(reloadPage,10000);</script><link href="https://fonts.googleapis.com/css2?family=Arimo:ital,wght@0,400..700;1,400..700&display=swap" rel="stylesheet"><title>Disk Space</title><div style="display:flex;flex-flow:column;justify-content:center;font-family:Arimo,monospace;font-weight:500;padding-top:3rem;padding-left:30rem;padding-right:30rem"><h1>Disk Space Usage</h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAACAAAAADsCAYAAADgzkauAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkNSURBVHhe7d2xVlpbuwbgz30tkMLhFcAVoI1V2nRQYpMupV0aKKFLm8pGuAK4AodF4FbO4axlyH+ys/+tE10ofD7PHg6XkM3KNMos3nfOeRKb6r9HnGw//5s/n9/1z//ppa/n/o9z/8cd2uu5/+Pc/3HHfv8/vfT13P9x7v+4Y7//n176eu7/OPd/3LHf/08vfT33f5z7P+7QXs/9H+f+jzv2+//ppa/n/o9z/8cd+/3/9NLXc//Huf/j9n7/P9OZ/9l+/uV/t59/8fzfef7vsj9/aH8fz/+d5//ujZ//a/sZAAAAAAAAADhiCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAAAAAAJKAAAAAAAAAAAAAJKAAAAAAAAAAAQAIKAAAAAAAAAACQgAIAAAAAAAAAACSgAAAAAAAAAAAACSgAAAAAAAAAAEACCgAAAAAAAAAAkIACAAAAAAAAAAAkoAAAAAAAAAAAAAkoAAAAAAAAAABAAgoAAAAAAAAAAJCAAgAAAAAA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">'

# "hostname": [["C", disk_free_bytes, disk_total_bytes, update_time_unix_seconds], ["D", disk_free_bytes, ...]]
spaces = {}

async def space(request):
    output = BASE
    output += f'<h2>Page last updated at: {asctime()}</h2>'
    # Sorts the worst offenders to the top
    for hostname, disks in sorted(spaces.items(), key=lambda x: max(y[1]/y[2] for y in x[1]), reverse=True):
        output += f'<h2>{hostname}</h2>'
        for letter, free, total, update_time in sorted(disks, key=lambda x: x[1]/x[2], reverse=True):
            output += f'<div style="background-color:rgb{colour_gradient(free/total)};display:flex;justify-content:center">'
            output += f'<p style="display:inline-block;padding-left:1rem;padding-right:1rem">{letter}: {round((free/total)*100, 2)}%, {convert_size(free)} free of {convert_size(total)}, last updated {int(time()-update_time)} second{"" if int(time()-update_time) == 1 else "s"} ago</p></div>'
    return aiohttp.web.Response(body=output, status=200, content_type="text/html")

async def submit(request):
    dat = await request.json()
    spaces[dat["hostname"]] = dat["disks"]
    return aiohttp.web.Response(status=200)

async def init():
    app = aiohttp.web.Application()
    app.router.add_get("/", space)
    app.router.add_post("/submit", submit)
    return app

if __name__ == "__main__":
    aiohttp.web.run_app(init(), port=8000)